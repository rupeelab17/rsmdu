name: Release Python

on:
  workflow_dispatch:
    inputs:
      # Latest commit to include with the release. If omitted, use the latest commit on the main branch.
      sha:
        description: Commit SHA
        type: string
      # Create the sdist and build the wheels, but do not publish to PyPI / GitHub.
      dry-run:
        description: Dry run
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ inputs.sha || github.sha }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

defaults:
  run:
    shell: bash

jobs:
  build-sdist:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Ajoutez un timeout
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip" # Ajoutez le cache

      - name: Install GDAL (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev gdal-bin

      - name: Install maturin
        run: pip install maturin

      - name: Create source distribution
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: >
            --manifest-path pymdurs/Cargo.toml
            --out dist
          maturin-version: 1.11.4

      # Test sdist disabled: pip install from sdist fails with "Large file option has not been set"
      # (zip64 error when pymdurs wheel exceeds ZIP limits). Wheels are tested in build-wheels job.

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  build-wheels:
    needs: [build-sdist]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-15-intel, macos-15]
        # os: [ubuntu-latest, macos-15-intel, macos-15, windows-latest]
        architecture: [x86-64, aarch64]
        exclude:
          - os: windows-latest
            architecture: aarch64
          - os: macos-15
            architecture: x86-64
          - os: macos-15-intel
            architecture: aarch64
          - os: ubuntu-latest
            architecture: aarch64

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Set swap space for Linux
        if: matrix.os == 'ubuntu-latest'
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install GDAL (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev gdal-bin libclang-dev

      - name: Install GDAL (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install gdal

      # === SECTION WINDOWS AVEC CONDA ===
      - name: Setup Miniconda (Windows)
        if: matrix.os == 'windows-latest'
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ env.PYTHON_VERSION }}
          channels: conda-forge
          channel-priority: strict

      - name: Install GDAL via Conda (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash -el {0}
        run: |
          # Installer libgdal qui contient les fichiers de développement
          conda install -c conda-forge libgdal geos proj sqlite m2w64-toolchain -y

          CONDA_PREFIX=$(conda info --base)
          CONDA_LIB="$CONDA_PREFIX/Library"

          echo "=== Checking installed files ==="
          echo "Library directory:"
          ls -la "$CONDA_LIB/lib/" | grep -i gdal || echo "No gdal in lib/"

          echo "Bin directory:"
          ls -la "$CONDA_LIB/bin/" | grep -i gdal || echo "No gdal in bin/"

          echo "Include directory:"
          ls -la "$CONDA_LIB/include/" | grep -i gdal || echo "No gdal in include/"

          # Chercher tous les fichiers GDAL
          echo "=== All GDAL files ==="
          find "$CONDA_LIB" -name "*gdal*" -o -name "*GDAL*" || echo "No GDAL files found"

          echo "GDAL_HOME=$CONDA_LIB" >> $GITHUB_ENV
          echo "GDAL_LIB_DIR=$CONDA_LIB/lib" >> $GITHUB_ENV
          echo "GDAL_INCLUDE_DIR=$CONDA_LIB/include" >> $GITHUB_ENV
          echo "GDAL_DATA=$CONDA_LIB/share/gdal" >> $GITHUB_ENV

          echo "GEOS_LIB_DIR=$CONDA_LIB/lib" >> $GITHUB_ENV
          echo "GEOS_INCLUDE_DIR=$CONDA_LIB/include" >> $GITHUB_ENV

          echo "PROJ_LIB=$CONDA_LIB/share/proj" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$CONDA_LIB/lib/pkgconfig" >> $GITHUB_ENV
          echo "RUST_BACKTRACE=1" >> $GITHUB_ENV

          echo "$CONDA_LIB/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

          echo "=== Verifying GDAL ==="
          gdalinfo --version || echo "gdalinfo not found"

      # - name: Install GDAL via vcpkg (Windows)
      #   if: matrix.os == 'windows-latest'
      #   run: |
      #     # Installer GDAL et ses dépendances via vcpkg
      #     vcpkg install gdal[core]:x64-windows
      #     vcpkg install geos:x64-windows
      #     vcpkg install proj:x64-windows
      #     vcpkg install sqlite3:x64-windows

      #     VCPKG_ROOT="C:/vcpkg"
      #     VCPKG_INSTALLED="$VCPKG_ROOT/installed/x64-windows"

      #     echo "=== Checking GDAL files ==="
      #     ls -la "$VCPKG_INSTALLED/lib/" | grep -i gdal
      #     ls -la "$VCPKG_INSTALLED/bin/" | grep -i gdal

      #     echo "GDAL_HOME=$VCPKG_INSTALLED" >> $GITHUB_ENV
      #     echo "GDAL_LIB_DIR=$VCPKG_INSTALLED/lib" >> $GITHUB_ENV
      #     echo "GDAL_INCLUDE_DIR=$VCPKG_INSTALLED/include" >> $GITHUB_ENV
      #     echo "GDAL_DATA=$VCPKG_INSTALLED/share/gdal" >> $GITHUB_ENV

      #     echo "GEOS_LIB_DIR=$VCPKG_INSTALLED/lib" >> $GITHUB_ENV
      #     echo "GEOS_INCLUDE_DIR=$VCPKG_INSTALLED/include" >> $GITHUB_ENV

      #     echo "PROJ_LIB=$VCPKG_INSTALLED/share/proj" >> $GITHUB_ENV
      #     echo "PKG_CONFIG_PATH=$VCPKG_INSTALLED/lib/pkgconfig" >> $GITHUB_ENV

      #     echo "$VCPKG_INSTALLED/bin" >> $GITHUB_PATH
      #     echo "$VCPKG_INSTALLED/tools" >> $GITHUB_PATH
      #     echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      #     choco install llvm -y
      #   env:
      #     CHOCOLATEY_NO_PROMPT: 1

      - name: Install LLVM (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install llvm -y
        env:
          CHOCOLATEY_NO_PROMPT: 1

      - name: Remove WindowsApps from PATH (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $path = ($env:Path -split ';' | Where-Object { $_ -notmatch 'WindowsApps' }) -join ';'
          echo "PATH=$path" >> $env:GITHUB_ENV

      - name: Install maturin
        run: pip install maturin

      - name: Set Rust target
        id: target
        run: |
          if [[ "${{ matrix.architecture }}" == "aarch64" ]]; then
            if [[ "${{ matrix.os }}" == "macos-15" ]]; then
              echo "target=aarch64-apple-darwin" >> $GITHUB_OUTPUT
            else
              echo "target=aarch64-unknown-linux-gnu" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ matrix.architecture }}" == "x86-64" ]]; then
            if [[ "${{ matrix.os }}" == "macos-15-intel" ]]; then
              echo "target=x86_64-apple-darwin" >> $GITHUB_OUTPUT
            elif [[ "${{ matrix.os }}" == "macos-26" ]]; then
              echo "target=x86_64-apple-darwin" >> $GITHUB_OUTPUT
            elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
              echo "target=x86_64-pc-windows-msvc" >> $GITHUB_OUTPUT
            else
              echo "target=x86_64-unknown-linux-gnu" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install Rust target
        run: rustup target add ${{ steps.target.outputs.target }}

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          command: build
          target: ${{ steps.target.outputs.target }}
          args: >
            --release
            --manifest-path pymdurs/Cargo.toml
            --out dist
          manylinux: ${{ matrix.os == 'ubuntu-latest' && 'off' || (matrix.architecture == 'aarch64' && '2_24' || 'auto') }}
          maturin-version: 1.11.4

      - name: Test wheel
        run: |
          pip install --force-reinstall --verbose dist/*.whl
          cd /tmp
          python -c 'import pymdurs; print("✅ pymdurs imported successfully")'
          python -c 'import pymdurs; print("Available classes:", [x for x in dir(pymdurs.geometric) if not x.startswith("_")])'
          python -c 'import pymdurs; bbox = pymdurs.PyBoundingBox(-1.0, 46.0, 1.0, 47.0); print("✅ PyBoundingBox works:", bbox.min_x)'

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.architecture }}
          path: dist/*.whl

  publish-to-pypi:
    needs: [build-sdist, build-wheels]
    environment:
      name: release-python
      url: https://pypi.org/project/pymdurs
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - name: Download sdists and wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        if: inputs.dry-run == false
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true

  publish-to-github:
    needs: [publish-to-pypi]
    if: inputs.dry-run == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Get version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -m 1 -oP 'version = "\K[^"]+' pyproject.toml)
          if [[ "$VERSION" == *"-"* ]] || [[ "$VERSION" == *"dev"* ]] || [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          name: Python pymdurs ${{ steps.version.outputs.version }}
          tag: py-${{ steps.version.outputs.version }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          files: dist/*
          body: |
            ## Python Package Release ${{ steps.version.outputs.version }}

            This release includes Python bindings for pymdurs.

            ### Installation

            ```bash
            pip install pymdurs
            ```

            ### Available Classes

            - `pymdurs.geometric.Building` - Building data collection
            - `pymdurs.geometric.Dem` - Digital Elevation Model
            - `pymdurs.geometric.Cadastre` - Cadastral parcel data
            - `pymdurs.geometric.Iris` - IRIS statistical units
            - `pymdurs.geometric.Lcz` - Local Climate Zone
            - `pymdurs.BoundingBox` - Bounding box operations
            - `pymdurs.GeoCore` - CRS and geographic operations

            ### Changes

            See the [changelog](https://github.com/rupeelab17/pymdurs/blob/main/CHANGELOG.md) for details.

            ### Requirements

            - Python >= 3.8
            - pandas >= 2.0.0
            - numpy < 2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

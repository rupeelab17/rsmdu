name: Release Python

on:
  workflow_dispatch:
    inputs:
      # Latest commit to include with the release. If omitted, use the latest commit on the main branch.
      sha:
        description: Commit SHA
        type: string
      # Create the sdist and build the wheels, but do not publish to PyPI / GitHub.
      dry-run:
        description: Dry run
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ inputs.sha || github.sha }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

defaults:
  run:
    shell: bash

jobs:
  build-sdist:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Ajoutez un timeout
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip" # Ajoutez le cache

      - name: Install GDAL (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev gdal-bin

      - name: Install maturin
        run: pip install maturin

      - name: Create source distribution
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: >
            --manifest-path pymdurs/Cargo.toml
            --out dist
          maturin-version: 1.11.4

      # Test sdist disabled: pip install from sdist fails with "Large file option has not been set"
      # (zip64 error when pymdurs wheel exceeds ZIP limits). Wheels are tested in build-wheels job.

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  build-wheels:
    needs: [build-sdist]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60 # Ajoutez un timeout plus long pour les wheels
    strategy:
      fail-fast: false
      matrix:
        # macos-15-intel is x86-64
        # macos-15 is aarch64
        os: [ubuntu-latest, macos-15-intel, macos-15, windows-latest]
        architecture: [x86-64, aarch64]
        exclude:
          - os: windows-latest
            architecture: aarch64
          - os: macos-15
            architecture: x86-64
          - os: macos-15-intel
            architecture: aarch64
          # Linux aarch64: manylinux cross-compilation container lacks GDAL headers
          - os: ubuntu-latest
            architecture: aarch64

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Set swap space for Linux
        if: matrix.os == 'ubuntu-latest'
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Remove WindowsApps from PATH (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $path = ($env:Path -split ';' | Where-Object { $_ -notmatch 'WindowsApps' }) -join ';'
          echo "PATH=$path" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Install GDAL (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev gdal-bin libclang-dev

      - name: Install GDAL (macOS)
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install gdal

      - name: Install GDAL, GEOS, PROJ and SQLite3 (Windows)
        if: matrix.os == 'windows-latest'
        id: setup-osgeo4w
        uses: echoix/setup-OSGeo4W@v0.2.0
        with:
          packages: gdal-devel geos-devel proj-devel sqlite3
      - name: Set env and install LLVM, pkg-config (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          O4W_ROOT="${{ steps.setup-osgeo4w.outputs.root }}"
          echo "GDAL_HOME=$O4W_ROOT" >> $GITHUB_ENV
          echo "GEOS_LIB_DIR=$O4W_ROOT/lib" >> $GITHUB_ENV
          echo "GEOS_INCLUDE_DIR=$O4W_ROOT/include" >> $GITHUB_ENV
          echo "GEOS_VERSION=3.12.1" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$O4W_ROOT/lib/pkgconfig" >> $GITHUB_ENV
          # Prepend Rust, OSGeo4W and Chocolatey bin to PATH
          echo "PATH=$HOME/.cargo/bin:$O4W_ROOT/bin:/c/ProgramData/chocolatey/bin:$PATH" >> $GITHUB_ENV
          # Help CMake find SQLite3 when proj-sys builds PROJ from source
          echo "SQLite3_ROOT=$O4W_ROOT" >> $GITHUB_ENV
          choco install llvm pkgconfiglite sqlite -y
        env:
          CHOCOLATEY_NO_PROMPT: 1

      - name: Install maturin
        run: pip install maturin

      - name: Set Rust target
        id: target
        run: |
          if [[ "${{ matrix.architecture }}" == "aarch64" ]]; then
            if [[ "${{ matrix.os }}" == "macos-15" ]]; then
              echo "target=aarch64-apple-darwin" >> $GITHUB_OUTPUT
            else
              echo "target=aarch64-unknown-linux-gnu" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ matrix.architecture }}" == "x86-64" ]]; then
            if [[ "${{ matrix.os }}" == "macos-15-intel" ]]; then
              echo "target=x86_64-apple-darwin" >> $GITHUB_OUTPUT
            elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
              echo "target=x86_64-pc-windows-msvc" >> $GITHUB_OUTPUT
            else
              echo "target=x86_64-unknown-linux-gnu" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Build wheel
        uses: PyO3/maturin-action@v1
        with:
          command: build
          target: ${{ steps.target.outputs.target }}
          args: >
            --release
            --manifest-path pymdurs/Cargo.toml
            --out dist
          manylinux: ${{ matrix.os == 'ubuntu-latest' && 'off' || (matrix.architecture == 'aarch64' && '2_24' || 'auto') }}
          maturin-version: 1.11.4

      - name: Test wheel
        run: |
          pip install --force-reinstall --verbose dist/*.whl
          # Run from /tmp to avoid repo source tree shadowing installed package
          # (see https://github.com/PyO3/maturin/issues/490)
          cd /tmp
          python -c 'import pymdurs; print("✅ pymdurs imported successfully")'
          python -c 'import pymdurs; print("Available classes:", [x for x in dir(pymdurs.geometric) if not x.startswith("_")])'
          python -c 'import pymdurs; bbox = pymdurs.PyBoundingBox(-1.0, 46.0, 1.0, 47.0); print("✅ PyBoundingBox works:", bbox.min_x)'

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.architecture }}
          path: dist/*.whl

  publish-to-pypi:
    needs: [build-sdist, build-wheels]
    environment:
      name: release-python
      url: https://pypi.org/project/pymdurs
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - name: Download sdists and wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        if: inputs.dry-run == false
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true

  publish-to-github:
    needs: [publish-to-pypi]
    if: inputs.dry-run == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.sha }}

      - name: Get version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -m 1 -oP 'version = "\K[^"]+' pyproject.toml)
          if [[ "$VERSION" == *"-"* ]] || [[ "$VERSION" == *"dev"* ]] || [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          name: Python pymdurs ${{ steps.version.outputs.version }}
          tag: py-${{ steps.version.outputs.version }}
          prerelease: ${{ steps.version.outputs.is_prerelease }}
          files: dist/*
          body: |
            ## Python Package Release ${{ steps.version.outputs.version }}

            This release includes Python bindings for pymdurs.

            ### Installation

            ```bash
            pip install pymdurs
            ```

            ### Available Classes

            - `pymdurs.geometric.Building` - Building data collection
            - `pymdurs.geometric.Dem` - Digital Elevation Model
            - `pymdurs.geometric.Cadastre` - Cadastral parcel data
            - `pymdurs.geometric.Iris` - IRIS statistical units
            - `pymdurs.geometric.Lcz` - Local Climate Zone
            - `pymdurs.BoundingBox` - Bounding box operations
            - `pymdurs.GeoCore` - CRS and geographic operations

            ### Changes

            See the [changelog](https://github.com/rupeelab17/pymdurs/blob/main/CHANGELOG.md) for details.

            ### Requirements

            - Python >= 3.8
            - pandas >= 2.0.0
            - numpy < 2.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
